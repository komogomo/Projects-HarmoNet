// HarmoNet Prisma Schema (v1.2)
// Source: 03_harmonet-er-entity-definition_v1.2.yaml
// Status: Phase5 完全統合版 (Gemini指摘⑤ TTSキャッシュ対応)
// Integration: Technical Stack Definition v3.5 (Next.js + Prisma 6.16.0+)
// Author: Tachikoma (HarmoNet PMO / Architect), Generated by Gemini

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // For migrations (RLS enabled)
}

// --- Enums ---

/// 共通ステータス
enum Status {
  active
  inactive
  archived
}

/// ロールスコープ
enum RoleScope {
  global
  tenant
}

/// 掲示板投稿ステータス
enum BoardPostStatus {
  draft
  pending
  published
  archived
}

/// 掲示板リアクション種別
enum BoardReactionType {
  like
  report
  bookmark
}

/// 承認アクション
enum ApprovalAction {
  approve
  reconsider
}

/// お知らせ配信対象モード
enum AnnouncementTargetMode {
  all
  group
  role
  user
}

/// 施設利用料 単位
enum FeeUnit {
  day
  hour
}

/// 施設区画ステータス
enum FacilitySlotStatus {
  active
  inactive
}

/// 施設予約ステータス
enum ReservationStatus {
  pending
  confirmed
  canceled
}

/// AIモデレーション判定
enum ModerationDecision {
  allow
  mask
  block
}

/// AIモデレーション判定者
enum ModerationDecidedBy {
  system
  human
}

// --- 1. Tenant Management ---

/// テナント基本情報
model tenants {
  id          String   @id @default(uuid())
  tenant_code String   @unique
  tenant_name String
  timezone    String
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  status      Status   @default(active)

  // Relations
  tenant_settings            tenant_settings[]
  tenant_features            tenant_features[]
  users                      users[] // For nullable tenant_id
  user_tenants               user_tenants[]
  user_roles                 user_roles[]
  user_profiles              user_profiles[]
  board_categories           board_categories[]
  board_posts                board_posts[]
  board_comments             board_comments[]
  board_reactions            board_reactions[]
  board_attachments          board_attachments[]
  board_approval_logs        board_approval_logs[]
  announcements              announcements[]
  facilities                 facilities[]
  facility_settings          facility_settings[]
  facility_slots             facility_slots[]
  facility_reservations      facility_reservations[]
  facility_blocked_ranges    facility_blocked_ranges[]
  translation_cache          translation_cache[]
  tts_cache                  tts_cache[]
  notifications              notifications[]
  user_notification_settings user_notification_settings[]
  audit_logs                 audit_logs[]
  moderation_logs            moderation_logs[]
}

/// テナント設定(JSON)
model tenant_settings {
  id               String   @id @default(uuid())
  tenant_id        String
  config_json      Json
  default_language String   @default("ja")
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt
  status           Status   @default(active)

  tenant tenants @relation(fields: [tenant_id], references: [id])
}

/// 機能フラグ
model tenant_features {
  id          String   @id @default(uuid())
  tenant_id   String
  feature_key String
  enabled     Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  status      Status   @default(active)

  tenant tenants @relation(fields: [tenant_id], references: [id])
}

// --- 2. Users / Auth ---

/// ユーザー基本情報（Supabase auth.users と1:1）
model users {
  id           String   @id @default(uuid())
  tenant_id    String? // 最後に所属したテナントIDなど (Nullable)
  email        String   @unique
  display_name String
  language     String   @default("ja")
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  status       Status   @default(active)

  // Relations
  tenant                     tenants?                     @relation(fields: [tenant_id], references: [id])
  user_tenants               user_tenants[]
  user_roles                 user_roles[]
  user_profiles              user_profiles[]
  board_posts                board_posts[]
  board_comments             board_comments[]
  board_reactions            board_reactions[]
  board_approval_logs        board_approval_logs[]
  announcement_reads         announcement_reads[]
  facility_reservations      facility_reservations[]
  notifications              notifications[]
  user_notification_settings user_notification_settings[]
  audit_logs                 audit_logs[]
  moderation_logs_reviewer   moderation_logs[] // 承認者としてのリレーション
}

/// ユーザーとテナントの所属関係
model user_tenants {
  user_id   String
  tenant_id String
  joined_at DateTime @default(now())
  status    Status   @default(active)

  user   users   @relation(fields: [user_id], references: [id])
  tenant tenants @relation(fields: [tenant_id], references: [id])

  @@id([user_id, tenant_id])
}

/// ユーザーごとのロール割り当て
model user_roles {
  user_id     String
  tenant_id   String
  role_id     String
  assigned_at DateTime @default(now())

  user   users   @relation(fields: [user_id], references: [id])
  tenant tenants @relation(fields: [tenant_id], references: [id])
  role   roles   @relation(fields: [role_id], references: [id])

  @@unique([user_id, tenant_id, role_id])
}

/// ユーザープロファイル設定
model user_profiles {
  user_id     String
  tenant_id   String
  preferences Json
  updated_at  DateTime @updatedAt

  user   users   @relation(fields: [user_id], references: [id])
  tenant tenants @relation(fields: [tenant_id], references: [id])

  @@id([user_id, tenant_id]) // ユーザーはテナントごとにプロファイルを持つ
}

// --- 3. Roles / Permissions ---

/// ロールマスタ
model roles {
  id              String   @id @default(uuid())
  role_key        String   @unique
  name            String
  scope           RoleScope
  permissions_ref String?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  // Relations
  user_roles       user_roles[]
  inherit_parent   role_inheritances[] @relation("parent")
  inherit_child    role_inheritances[] @relation("child")
  role_permissions role_permissions[]
}

/// ロール継承関係
model role_inheritances {
  parent_role_id String
  child_role_id  String

  parent roles @relation("parent", fields: [parent_role_id], references: [id])
  child  roles @relation("child", fields: [child_role_id], references: [id])

  @@id([parent_role_id, child_role_id])
}

/// 権限マスタ
model permissions {
  id             String   @id @default(uuid())
  permission_key String   @unique
  resource       String
  action         String

  // Relations
  role_permissions role_permissions[]
}

/// ロール権限紐付け
model role_permissions {
  role_id       String
  permission_id String

  role       roles       @relation(fields: [role_id], references: [id])
  permission permissions @relation(fields: [permission_id], references: [id])

  @@unique([role_id, permission_id])
}

// --- 4. Board ---

/// 掲示板カテゴリ
model board_categories {
  id                String   @id @default(uuid())
  tenant_id         String
  category_key      String
  category_name     String
  requires_approval Boolean  @default(false)
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  status            Status   @default(active)

  tenant tenants     @relation(fields: [tenant_id], references: [id])
  posts  board_posts[]
}

/// 掲示板投稿
model board_posts {
  id          String          @id @default(uuid())
  tenant_id   String
  author_id   String
  category_id String
  title       String
  content     String          @db.Text
  tags        String[]
  status      BoardPostStatus @default(draft)
  created_at  DateTime        @default(now())
  updated_at  DateTime        @updatedAt

  // Relations
  tenant        tenants             @relation(fields: [tenant_id], references: [id])
  author        users               @relation(fields: [author_id], references: [id])
  category      board_categories    @relation(fields: [category_id], references: [id])
  comments      board_comments[]
  reactions     board_reactions[]
  attachments   board_attachments[]
  approval_logs board_approval_logs[]
}

/// 投稿コメント
model board_comments {
  id                String   @id @default(uuid())
  tenant_id         String
  post_id           String
  author_id         String
  content           String   @db.Text
  parent_comment_id String?

  // Relations
  tenant tenants     @relation(fields: [tenant_id], references: [id])
  post   board_posts @relation(fields: [post_id], references: [id], onDelete: Cascade)
  author users       @relation(fields: [author_id], references: [id])
}

/// 投稿リアクション
model board_reactions {
  id            String            @id @default(uuid())
  tenant_id     String
  post_id       String
  user_id       String
  reaction_type BoardReactionType
  created_at    DateTime          @default(now())

  // Relations
  tenant tenants     @relation(fields: [tenant_id], references: [id])
  post   board_posts @relation(fields: [post_id], references: [id], onDelete: Cascade)
  user   users       @relation(fields: [user_id], references: [id])

  @@unique([post_id, user_id, reaction_type])
}

/// 添付ファイル（PDFプレビュー対応）
model board_attachments {
  id        String   @id @default(uuid())
  tenant_id String
  post_id   String
  file_url  String
  file_name String
  file_type String
  file_size Int
  created_at DateTime @default(now())

  // Relations
  tenant tenants     @relation(fields: [tenant_id], references: [id])
  post   board_posts @relation(fields: [post_id], references: [id], onDelete: Cascade)
}

/// 承認履歴
model board_approval_logs {
  id          String         @id @default(uuid())
  tenant_id   String
  post_id     String
  approver_id String
  action      ApprovalAction
  comment     String         @db.Text
  acted_at    DateTime       @default(now())

  // Relations
  tenant   tenants     @relation(fields: [tenant_id], references: [id])
  post     board_posts @relation(fields: [post_id], references: [id], onDelete: Cascade)
  approver users       @relation(fields: [approver_id], references: [id])
}

// --- 5. Announcements ---

/// お知らせ
model announcements {
  id          String                 @id @default(uuid())
  tenant_id   String
  title       String
  content     String                 @db.Text
  target_mode AnnouncementTargetMode @default(all)
  valid_from  DateTime               @default(now()) @db.Date
  valid_until DateTime?              @db.Date
  created_at  DateTime               @default(now())
  updated_at  DateTime               @updatedAt

  // Relations
  tenant  tenants              @relation(fields: [tenant_id], references: [id])
  reads   announcement_reads[]
  targets announcement_targets[]
}

/// お知らせ既読管理
model announcement_reads {
  announcement_id String
  user_id         String
  read_at         DateTime

  // Relations
  announcement announcements @relation(fields: [announcement_id], references: [id], onDelete: Cascade)
  user         users         @relation(fields: [user_id], references: [id])

  @@unique([announcement_id, user_id])
}

/// お知らせ配信対象
model announcement_targets {
  id              String @id @default(uuid())
  announcement_id String
  target_type     String // "group", "role", "user"
  target_id       String // UUID of the target

  // Relations
  announcement announcements @relation(fields: [announcement_id], references: [id], onDelete: Cascade)
}

// --- 6. Facilities / Reservations ---

/// 施設マスタ
model facilities {
  id            String   @id @default(uuid())
  tenant_id     String
  facility_name String
  facility_type String
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  // Relations
  tenant         tenants                   @relation(fields: [tenant_id], references: [id])
  settings       facility_settings? // 1:1 relation
  slots          facility_slots[]
  reservations   facility_reservations[]
  blocked_ranges facility_blocked_ranges[]
}

/// 施設別の利用ルール設定
model facility_settings {
  id                      String   @id @default(uuid())
  tenant_id               String
  facility_id             String   @unique // 1:1 relation to facilities
  fee_per_day             Decimal? @db.Decimal(8, 2)
  fee_unit                FeeUnit  @default(day)
  max_consecutive_days    Int      @default(3)
  reservable_until_months Int      @default(1)
  created_at              DateTime @default(now())
  updated_at              DateTime @updatedAt

  // Relations
  tenant   tenants    @relation(fields: [tenant_id], references: [id])
  facility facilities @relation(fields: [facility_id], references: [id])
}

/// 施設区画
model facility_slots {
  id          String             @id @default(uuid())
  tenant_id   String
  facility_id String
  slot_key    String
  slot_name   String
  status      FacilitySlotStatus @default(active)

  // Relations
  tenant       tenants               @relation(fields: [tenant_id], references: [id])
  facility     facilities            @relation(fields: [facility_id], references: [id])
  reservations facility_reservations[]
}

/// 施設予約
model facility_reservations {
  id          String            @id @default(uuid())
  tenant_id   String
  facility_id String
  slot_id     String?
  user_id     String
  start_at    DateTime
  end_at      DateTime
  status      ReservationStatus @default(pending)
  created_at  DateTime          @default(now())
  updated_at  DateTime          @updatedAt

  // Relations
  tenant   tenants        @relation(fields: [tenant_id], references: [id])
  facility facilities     @relation(fields: [facility_id], references: [id])
  slot     facility_slots? @relation(fields: [slot_id], references: [id])
  user     users          @relation(fields: [user_id], references: [id])
}

/// 予約不可期間
model facility_blocked_ranges {
  id          String   @id @default(uuid())
  tenant_id   String
  facility_id String
  start_at    DateTime
  end_at      DateTime
  reason      String   @db.Text

  // Relations
  tenant   tenants    @relation(fields: [tenant_id], references: [id])
  facility facilities @relation(fields: [facility_id], references: [id])
}

// --- 7. Translation / Cache ---

/// 翻訳キャッシュ（Redis失効後の永続履歴）
model translation_cache {
  id              String   @id @default(uuid())
  tenant_id       String
  content_type    String
  content_id      String
  language        String
  translated_text String   @db.Text
  expires_at      DateTime @doc("キャッシュ有効期限 (デフォルト30日)")

  // Relations
  tenant tenants @relation(fields: [tenant_id], references: [id])

  @@unique([tenant_id, content_type, content_id, language])
}

/// 音声読み上げキャッシュ（TTS出力の再生成防止と高速再利用用）
model tts_cache {
  id           String   @id @default(uuid())
  tenant_id    String
  content_type String   @doc("post, comment など")
  content_id   String
  language     String   @doc("音声生成言語コード (ja, en, zh 等)")
  voice_type   String   @default("default") @doc("音声スタイル・声質名")
  audio_url    String   @doc("Supabase Storage または CDN 上の音声ファイルURL")
  duration_sec Decimal? @db.Decimal(6, 2)
  expires_at   DateTime @doc("キャッシュ有効期限 (デフォルト30日)")
  created_at   DateTime @default(now())

  // Relations
  tenant tenants @relation(fields: [tenant_id], references: [id])

  @@unique([tenant_id, content_type, content_id, language])
}

// --- 8. Notifications ---

/// 通知履歴
model notifications {
  id        String   @id @default(uuid())
  tenant_id String
  user_id   String
  type      String
  title     String
  content   String   @db.Text
  sent_at   DateTime @default(now())
  read_at   DateTime?

  // Relations
  tenant tenants @relation(fields: [tenant_id], references: [id])
  user   users   @relation(fields: [user_id], references: [id])
}

/// ユーザー通知設定
model user_notification_settings {
  user_id           String
  tenant_id         String
  notification_type String
  enabled           Boolean  @default(true)
  updated_at        DateTime @updatedAt

  // Relations
  user   users   @relation(fields: [user_id], references: [id])
  tenant tenants @relation(fields: [tenant_id], references: [id])

  @@unique([user_id, tenant_id, notification_type])
}

// --- 9. Audit / Moderation ---

/// 監査ログ
model audit_logs {
  id              String   @id @default(uuid())
  tenant_id       String
  user_id         String
  action_type     String
  target_resource String
  target_id       String?
  ip_address      String
  user_agent      String
  timestamp       DateTime @default(now())

  // Relations
  tenant tenants @relation(fields: [tenant_id], references: [id])
  user   users   @relation(fields: [user_id], references: [id])
}

/// AIモデレーションログ
model moderation_logs {
  id             String             @id @default(uuid())
  tenant_id      String
  content_type   String
  content_id     String
  ai_score       Decimal            @db.Decimal(5, 2)
  flagged_reason String             @db.Text
  decision       ModerationDecision @default(allow)
  decided_by     ModerationDecidedBy @default(system)
  decided_at     DateTime           @default(now())
  reviewed_by    String?

  // Relations
  tenant   tenants @relation(fields: [tenant_id], references: [id])
  reviewer users?  @relation(fields: [reviewed_by], references: [id])
}