// HarmoNet Prisma Schema (v1.7-clean)
// Source: 03_harmonet-er-entity-definition_v1.2.yaml
// Status: Phase9 ENUM統一版 (重複削除・PostgreSQL最適化)
// Integration: Technical Stack Definition v3.5 (Next.js + Prisma 6.16.0+)
// Author: Tachikoma (HarmoNet PMO / Architect), Modified by Claude, Cleaned by Tachikoma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // directUrl = env("DIRECT_URL") // マイグレーション時に必要な場合のみ使用
}

// ===== Unified Enums (PostgreSQL snake_case standard) =====

/// 共通ステータス
enum status {
  active
  inactive
  archived
}

/// ロールスコープ
enum role_scope {
  system_admin
  tenant_admin
  general_user
}

/// 掲示板投稿ステータス
enum board_post_status {
  draft
  pending
  published
  archived
}

/// 掲示板リアクション種別
enum board_reaction_type {
  like
  report
  bookmark
}

/// 承認アクション
enum approval_action {
  approve
  reconsider
}

enum board_author_role {
  management // 管理組合として投稿
  general // 一般利用者として投稿
}

/// お知らせ配信対象モード
enum announcement_target_mode {
  all
  group
  role
  user
}

/// 施設利用料 単位
enum fee_unit {
  day
  hour
}

/// 施設区画ステータス
enum facility_slot_status {
  active
  inactive
}

/// 施設予約ステータス
enum reservation_status {
  pending
  confirmed
  canceled
}

/// AIモデレーション判定
enum moderation_decision {
  allow
  mask
  block
}

/// AIモデレーション判定者
enum decision_source {
  system
  human
}

/// フッターショートカット機能キー
enum shortcut_feature_key {
  home
  board
  facility
  mypage
  logout
}

enum comment_status {
  active // 通常表示
  deleted // 論理削除（UIには出さない or 特別扱い）
}

// ===== Models =====

// --- 1. Tenant Management ---

/// テナント基本情報
model tenants {
  id          String   @id @default(uuid())
  tenant_code String   @unique
  tenant_name String
  timezone    String
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  status      status   @default(active)

  // Relations
  tenant_settings            tenant_settings[]
  tenant_features            tenant_features[]
  tenant_shortcut_menu       tenant_shortcut_menu[]
  users                      users[] // for nullable tenant_id
  user_tenants               user_tenants[]
  user_roles                 user_roles[]
  board_categories           board_categories[]
  board_posts                board_posts[]
  board_comments             board_comments[]
  board_reactions            board_reactions[]
  board_attachments          board_attachments[]
  board_approval_logs        board_approval_logs[]
  board_favorites            board_favorites[]
  announcements              announcements[]
  facilities                 facilities[]
  facility_settings          facility_settings[]
  facility_slots             facility_slots[]
  facility_reservations      facility_reservations[]
  facility_blocked_ranges    facility_blocked_ranges[]
  audit_logs                 audit_logs[]
  moderation_logs            moderation_logs[]
  board_post_translations    board_post_translations[]
  board_comment_translations board_comment_translations[]
  tenant_residents           tenant_residents[]
}

/// テナント設定(JSON)
model tenant_settings {
  id               String   @id @default(uuid())
  tenant_id        String
  config_json      Json
  default_language String   @default("ja")
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt
  status           status   @default(active)

  tenant tenants @relation(fields: [tenant_id], references: [id])

  @@index([tenant_id])
}

/// 機能フラグ
model tenant_features {
  id          String   @id @default(uuid())
  tenant_id   String
  feature_key String
  enabled     Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  status      status   @default(active)

  tenant tenants @relation(fields: [tenant_id], references: [id])

  @@index([tenant_id])
}

// --- 2. Users / Auth ---

/// ユーザー認証情報（Supabase auth.users と1:1）
model users {
  id             String   @id @default(uuid())
  tenant_id      String // NOT NULL に変更: 1ユーザ=1テナント
  email          String   @unique
  display_name   String   @unique
  full_name      String // 正式氏名
  full_name_kana String? // 氏名ヨミ（任意）
  group_code     String // 街区/棟など (例: "N-A")
  residence_code String // 住戸番号 (例: "101", "1205A")
  phone_number   String? // (任意)
  language       String   @default("JA") // UI表示言語コード ("JA" | "EN" | "ZH")
  note           String? // 備考（最大200文字相当を想定）
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  // Relations
  tenant                   tenants                 @relation(fields: [tenant_id], references: [id])
  user_tenants             user_tenants[]
  user_roles               user_roles[]
  board_posts              board_posts[]
  board_comments           board_comments[]
  board_reactions          board_reactions[]
  board_favorites          board_favorites[]
  announcement_reads       announcement_reads[]
  facility_reservations    facility_reservations[]
  audit_logs               audit_logs[]
  moderation_logs_reviewer moderation_logs[]
  tenant_residents         tenant_residents[]
  boardApprovalLogs        board_approval_logs[]

  @@index([tenant_id])
}

/// 住民基本情報
model tenant_residents {
  id             String  @id @default(uuid())
  tenant_id      String
  user_id        String?
  residence_code String
  real_name      String
  real_name_kana String
  phone_number   String?
  status         status  @default(active)

  // Relations
  tenant tenants @relation(fields: [tenant_id], references: [id])
  user   users?  @relation(fields: [user_id], references: [id])

  @@unique([tenant_id, residence_code])
  @@index([tenant_id])
  @@index([user_id])
}

/// ユーザーとテナントの所属関係
model user_tenants {
  user_id            String
  tenant_id          String
  board_last_seen_at DateTime?

  user   users   @relation(fields: [user_id], references: [id])
  tenant tenants @relation(fields: [tenant_id], references: [id])

  @@id([user_id, tenant_id])
  @@index([tenant_id])
}

/// ユーザーごとのロール割り当て
model user_roles {
  user_id     String
  tenant_id   String
  role_id     String
  assigned_at DateTime @default(now())

  user   users   @relation(fields: [user_id], references: [id])
  tenant tenants @relation(fields: [tenant_id], references: [id])
  role   roles   @relation(fields: [role_id], references: [id])

  @@id([user_id, tenant_id, role_id])
  @@index([tenant_id])
  @@index([role_id])
}

// --- 3. Roles / Permissions ---

/// ロールマスタ
model roles {
  id              String     @id @default(uuid())
  role_key        String     @unique
  name            String
  scope           role_scope
  permissions_ref String?
  created_at      DateTime   @default(now())
  updated_at      DateTime   @updatedAt

  // Relations
  user_roles       user_roles[]
  inherit_parent   role_inheritances[] @relation("parent")
  inherit_child    role_inheritances[] @relation("child")
  role_permissions role_permissions[]
}

/// ロール継承関係
model role_inheritances {
  parent_role_id String
  child_role_id  String

  parent roles @relation("parent", fields: [parent_role_id], references: [id])
  child  roles @relation("child", fields: [child_role_id], references: [id])

  @@id([parent_role_id, child_role_id])
  @@index([child_role_id])
}

/// 権限マスタ
model permissions {
  id             String   @id @default(uuid())
  permission_key String   @unique
  resource       String
  action         String
  description    String?
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  // Relations
  role_permissions role_permissions[]
}

/// ロールと権限の紐付け
model role_permissions {
  role_id       String
  permission_id String

  role       roles       @relation(fields: [role_id], references: [id])
  permission permissions @relation(fields: [permission_id], references: [id])

  @@id([role_id, permission_id])
  @@index([permission_id])
}

// --- 4. Board / Community ---

/// 掲示板カテゴリ
model board_categories {
  id            String   @id @default(uuid())
  tenant_id     String
  category_key  String
  category_name String
  display_order Int      @default(0)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  status        status   @default(active)

  // Relations
  tenant tenants       @relation(fields: [tenant_id], references: [id])
  posts  board_posts[]

  @@unique([tenant_id, category_key])
}

/// 掲示板投稿
model board_posts {
  id                  String            @id @default(uuid())
  tenant_id           String
  category_id         String
  author_id           String
  author_display_name String?
  author_role         board_author_role @default(general)
  title               String
  content             String            @db.Text // テキスト正（翻訳/TTS/モデレーション/検索用）
  status              board_post_status @default(draft)
  created_at          DateTime          @default(now())
  updated_at          DateTime          @updatedAt

  // Relations
  tenant        tenants                   @relation(fields: [tenant_id], references: [id])
  author        users                     @relation(fields: [author_id], references: [id])
  category      board_categories          @relation(fields: [category_id], references: [id])
  comments      board_comments[]
  reactions     board_reactions[]
  attachments   board_attachments[]
  approval_logs board_approval_logs[]
  translations  board_post_translations[]
  favorites     board_favorites[]

  @@index([tenant_id])
  @@index([category_id])
  @@index([author_id])
}

/// 投稿コメント
model board_comments {
  id                  String         @id @default(uuid())
  tenant_id           String
  post_id             String
  author_id           String
  content             String         @db.Text
  parent_comment_id   String?
  created_at          DateTime       @default(now())
  updated_at          DateTime       @updatedAt
  status              comment_status @default(active)
  author_display_name String?        @db.VarChar(100)

  // Relations
  tenant                   tenants                      @relation(fields: [tenant_id], references: [id])
  post                     board_posts                  @relation(fields: [post_id], references: [id], onDelete: Cascade)
  author                   users                        @relation(fields: [author_id], references: [id])
  boardCommentTranslations board_comment_translations[]

  @@index([tenant_id])
  @@index([post_id])
  @@index([author_id])
}

/// 投稿リアクション
model board_reactions {
  id            String              @id @default(uuid())
  tenant_id     String
  post_id       String
  user_id       String
  reaction_type board_reaction_type
  created_at    DateTime            @default(now())

  // Relations
  tenant tenants     @relation(fields: [tenant_id], references: [id])
  post   board_posts @relation(fields: [post_id], references: [id], onDelete: Cascade)
  user   users       @relation(fields: [user_id], references: [id])

  @@unique([post_id, user_id, reaction_type])
  @@index([tenant_id])
  @@index([post_id])
  @@index([user_id])
}

/// 添付ファイル（PDFプレビュー対応）
model board_attachments {
  id         String   @id @default(uuid())
  tenant_id  String
  post_id    String
  file_url   String
  file_name  String
  file_type  String
  file_size  Int
  created_at DateTime @default(now())

  // Relations
  tenant tenants     @relation(fields: [tenant_id], references: [id])
  post   board_posts @relation(fields: [post_id], references: [id], onDelete: Cascade)

  @@index([tenant_id])
  @@index([post_id])
}

/// 承認履歴
model board_approval_logs {
  id          String          @id @default(uuid())
  tenant_id   String
  post_id     String
  approver_id String
  action      approval_action
  comment     String          @db.Text
  acted_at    DateTime        @default(now())

  // Relations
  tenant   tenants     @relation(fields: [tenant_id], references: [id])
  post     board_posts @relation(fields: [post_id], references: [id], onDelete: Cascade)
  approver users       @relation(fields: [approver_id], references: [id])

  @@index([tenant_id])
  @@index([post_id])
  @@index([approver_id])
}

/// 投稿記事のお気に入り
model board_favorites {
  id         String   @id @default(uuid())
  tenant_id  String
  user_id    String
  post_id    String
  created_at DateTime @default(now())

  tenant tenants     @relation(fields: [tenant_id], references: [id])
  user   users       @relation(fields: [user_id], references: [id])
  post   board_posts @relation(fields: [post_id], references: [id], onDelete: Cascade)

  @@unique([tenant_id, user_id, post_id])
  @@index([tenant_id])
  @@index([user_id])
  @@index([post_id])
}

// --- 5. Announcements ---

/// お知らせ
model announcements {
  id          String                   @id @default(uuid())
  tenant_id   String
  title       String
  content     String                   @db.Text
  target_mode announcement_target_mode @default(all)
  valid_from  DateTime                 @default(now())
  valid_until DateTime?
  created_at  DateTime                 @default(now())
  updated_at  DateTime                 @updatedAt

  // Relations
  tenant  tenants                @relation(fields: [tenant_id], references: [id])
  reads   announcement_reads[]
  targets announcement_targets[]

  @@index([tenant_id])
}

/// お知らせ既読管理
model announcement_reads {
  announcement_id String
  user_id         String
  read_at         DateTime

  // Relations
  announcement announcements @relation(fields: [announcement_id], references: [id], onDelete: Cascade)
  user         users         @relation(fields: [user_id], references: [id])

  @@id([announcement_id, user_id])
  @@index([user_id])
}

/// お知らせ配信対象
model announcement_targets {
  id              String @id @default(uuid())
  announcement_id String
  target_type     String // "group", "role", "user"
  target_id       String // UUID of the target

  // Relations
  announcement announcements @relation(fields: [announcement_id], references: [id], onDelete: Cascade)

  @@index([announcement_id])
}

// --- 6. Facilities / Reservations ---

/// 施設マスタ
model facilities {
  id            String   @id @default(uuid())
  tenant_id     String
  facility_name String
  facility_type String
  description   String? // 施設説明・備考
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  // Relations
  tenant         tenants                   @relation(fields: [tenant_id], references: [id])
  settings       facility_settings? // 1:1 relation
  slots          facility_slots[]
  reservations   facility_reservations[]
  blocked_ranges facility_blocked_ranges[]

  @@index([tenant_id])
}

/// 施設別の利用ルール設定
model facility_settings {
  id                      String   @id @default(uuid())
  tenant_id               String
  facility_id             String   @unique // 1:1 relation to facilities
  fee_per_day             Decimal? @db.Decimal(8, 2)
  fee_unit                fee_unit @default(day)
  max_consecutive_days    Int      @default(3)
  reservable_until_months Int      @default(1)
  slot_duration_minutes   Int      @default(30)
  available_from_time     String   @default("09:00")
  available_to_time       String   @default("19:00")
  monthly_limit           Int?
  cancel_restriction_days Int      @default(1) // キャンセル可能期限（X日前まで）
  created_at              DateTime @default(now())
  updated_at              DateTime @updatedAt

  // Relations
  tenant   tenants    @relation(fields: [tenant_id], references: [id])
  facility facilities @relation(fields: [facility_id], references: [id])

  @@index([tenant_id])
}

/// 施設区画
model facility_slots {
  id          String               @id @default(uuid())
  tenant_id   String
  facility_id String
  slot_key    String
  slot_name   String
  status      facility_slot_status @default(active)
  meta        Json?                // 座標データ { x: 10, y: 20, w: 5, h: 5 } 等

  // Relations
  tenant       tenants                 @relation(fields: [tenant_id], references: [id])
  facility     facilities              @relation(fields: [facility_id], references: [id])
  reservations facility_reservations[]

  @@index([tenant_id])
  @@index([facility_id])
}

/// 施設予約
model facility_reservations {
  id          String             @id @default(uuid())
  tenant_id   String
  facility_id String
  slot_id     String?
  user_id     String
  start_at    DateTime
  end_at      DateTime
  purpose           String?
  participant_count Int?
  meta              Json?
  status      reservation_status @default(pending)
  created_at  DateTime           @default(now())
  updated_at  DateTime           @updatedAt

  // Relations
  tenant   tenants         @relation(fields: [tenant_id], references: [id])
  facility facilities      @relation(fields: [facility_id], references: [id])
  slot     facility_slots? @relation(fields: [slot_id], references: [id])
  user     users           @relation(fields: [user_id], references: [id])

  @@index([tenant_id])
  @@index([facility_id])
  @@index([slot_id])
  @@index([user_id])
}

/// 予約不可期間
model facility_blocked_ranges {
  id          String   @id @default(uuid())
  tenant_id   String
  facility_id String
  start_at    DateTime
  end_at      DateTime
  reason      String   @db.Text

  // Relations
  tenant   tenants    @relation(fields: [tenant_id], references: [id])
  facility facilities @relation(fields: [facility_id], references: [id])

  @@index([tenant_id])
  @@index([facility_id])
}

// --- 7. Audit / Moderation ---

/// 監査ログ
model audit_logs {
  id              String   @id @default(uuid())
  tenant_id       String
  user_id         String
  action_type     String
  target_resource String
  target_id       String?
  ip_address      String
  user_agent      String
  timestamp       DateTime @default(now())

  // Relations
  tenant tenants @relation(fields: [tenant_id], references: [id])
  user   users   @relation(fields: [user_id], references: [id])

  @@index([tenant_id])
  @@index([user_id])
}

/// AIモデレーションログ
model moderation_logs {
  id             String              @id @default(uuid())
  tenant_id      String
  content_type   String
  content_id     String
  ai_score       Decimal             @db.Decimal(5, 2)
  flagged_reason String              @db.Text
  decision       moderation_decision @default(allow)
  decided_by     decision_source     @default(system)
  decided_at     DateTime            @default(now())
  reviewed_by    String?

  // Relations
  tenant   tenants @relation(fields: [tenant_id], references: [id])
  reviewer users?  @relation(fields: [reviewed_by], references: [id])

  @@index([tenant_id])
  @@index([reviewed_by])
}

// --- 8. UI Configuration ---

/// テナント別フッターショートカットメニュー構成
/// フッターショートカットバーの表示項目・順序・アイコンを定義
model tenant_shortcut_menu {
  id            String               @id @default(uuid())
  tenant_id     String
  feature_key   shortcut_feature_key
  label_key     String // i18nキー（例: "nav.home"）
  icon          String // lucideアイコン名（例: "Home", "MessageSquare"）
  display_order Int
  enabled       Boolean              @default(true) // UI表示の有効/無効
  created_at    DateTime             @default(now())
  updated_at    DateTime             @updatedAt
  status        status               @default(active) // 論理削除用

  // Relations
  tenant tenants @relation(fields: [tenant_id], references: [id])

  @@unique([tenant_id, feature_key])
  @@index([tenant_id, display_order])
}

/// 掲示板新規投稿用の翻訳
model board_post_translations {
  id        String  @id @default(uuid())
  tenant_id String
  post_id   String
  lang      String
  title     String?
  content   String  @db.Text

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  tenant tenants     @relation(fields: [tenant_id], references: [id])
  post   board_posts @relation(fields: [post_id], references: [id], onDelete: Cascade)

  @@unique([post_id, lang])
  @@index([tenant_id, lang, created_at])
}

/// 掲示板投稿画面返信用の翻訳
model board_comment_translations {
  id         String @id @default(uuid())
  tenant_id  String
  comment_id String
  lang       String
  content    String @db.Text

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  tenant  tenants        @relation(fields: [tenant_id], references: [id])
  comment board_comments @relation(fields: [comment_id], references: [id], onDelete: Cascade)

  @@unique([comment_id, lang])
  @@index([tenant_id, lang, created_at])
}
